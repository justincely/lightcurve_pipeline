#! /usr/bin/env python

"""
Reset all tables in the database.
"""

from __future__ import print_function

from astropy.io import fits
from astropy.table import Table
import bokeh
from bokeh import charts
from bokeh.io import gridplot
from bokeh.plotting import figure
from bokeh.embed import components
from bokeh import palettes

import itertools
from collections import Counter
#import seaborn as sns
import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
#sns.set(style="dark")
import multiprocessing as mp

from sqlalchemy.engine import create_engine

import glob
import numpy as np
import os

from lightcurve_pipeline.utils.utils import SETTINGS
from lightcurve_pipeline.database.database_interface import engine
from lightcurve_pipeline.database.database_interface import session
from lightcurve_pipeline.database.database_interface import Metadata
from lightcurve_pipeline.database.database_interface import Stats

#-------------------------------------------------------------------------------

def bar_opt_elem():
    """
    Create a bar chart showing the number of composite lightcurves
    for each COS & STIS optical element
    """

    # Query for data
    query = session.query(Metadata.instrume, Metadata.opt_elem).all()
    instrumes = [result[0] for result in query]
    opt_elems = [result[1] for result in query]
    opt_elems_set = sorted(list(set(opt_elems)))

    # Initialize dictionaries that store all optical elements
    cos_dict, stis_dict = {}, {}
    for opt_elem in opt_elems_set:
        cos_dict[opt_elem] = 0
        stis_dict[opt_elem] = 0

    # Count number of opt_elems
    for instrument, opt_elem in zip(instrumes, opt_elems):
        if instrument == 'COS':
            cos_dict[opt_elem] += 1
        elif instrument == 'STIS':
            stis_dict[opt_elem] += 1

    # Determine plotting values
    cat = list(opt_elems_set)
    xyvalues = OrderedDict()
    xyvalues['COS'] = [cos_dict[opt_elem] for opt_elem in opt_elems_set]
    xyvalues['STIS'] = [stis_dict[opt_elem] for opt_elem in opt_elems_set]

    # Make plots
    bar = charts.Bar(xyvalues,
        cat,
        xlabel="Optical Element",
        ylabel="# of Lightcurves",
        stacked=True,
        legend = "top_right")
    bar.background_fill = "#cccccc"
    bar.outline_line_color = 'black'
    charts.output_file(os.path.join(SETTINGS['plot_dir'], "opt_elem.html"))
    #charts.show(bar)

#-------------------------------------------------------------------------------

def histogram_exptime():
    print("Starting the histogram")

    data_dir = SETTINGS['composite_dir']
    #plot_dir = SETTINGS['plot']
    data_dir = '/Volumes/papers/hst13902/outputs/composite/'

    exptime_data = {}
    for dataset in glob.glob(os.path.join(data_dir, '*.fits')):
        print(dataset)
        with fits.open(dataset) as hdu:
            targname = os.path.split(dataset)[-1].split('_')[0] #hdu[0].header['targname']
            exptime = hdu[0].header['EXPTIME']

            if targname in exptime_data:
                exptime_data[targname] += exptime
            else:
                exptime_data[targname] = exptime

    charts.output_file(os.path.join(SETTINGS['plot_dir'], "exptime_histogram.html"))

    times = np.array(exptime_data.values())
    names = np.array(exptime_data.keys())
    indx = np.argsort(times)

    times = list(times[indx])[::-1][:30]
    names = list(names[indx])[::-1][:30]

    bar = charts.Bar(times,
                     cat=names,
                     xlabel='Target',
                     ylabel='Exptime (s)',
                     width=700,
                     height=400,
                     title='Cumulative Exptime per Target')

    bar.background_fill = "#cccccc"
    bar.outline_line_color = 'black'

    # change just some things about the x-grid
    #bar.xgrid.grid_line_color = None

    # change just some things about the y-grid
    #bar.ygrid.band_fill_alpha = 0.1
    #bar.ygrid.band_fill_color = "navy"

    #bar.toolbar_location = None

    #charts.show(bar)

    script, div = components(bar)

    print(div)
    print()
    print(script)

#-------------------------------------------------------------------------------

def piechart_config():
    print("Starting the piechart")

    data_dir = SETTINGS['composite_dir']
    #plot_dir = SETTINGS['plot']

    configs = {}
    for dataset in glob.glob(os.path.join(data_dir, '*.fits')):
        #with fits.open(dataset) as hdu:
        #    exptime = hdu[0].header['TOTTIME'] #hdu[0].header['EXPTIME']

        instrument = os.path.split(dataset)[1].split('_')[1]
        grating = os.path.split(dataset)[1].split('_')[2]
        cenwave = os.path.split(dataset)[1].split('_')[3]

        if not instrument in configs:
            configs[instrument] = [grating+'/'+cenwave]
        else:
            configs[instrument].append(grating+'/'+cenwave)

        print(instrument, grating, cenwave)

    #-- COS FUV
    settings = Counter(configs['FUV'])
    charts.output_file("pie_config_cos_fuv.html")

    plot = charts.Donut(settings.values(),
                        settings.keys(),
                        width=1200,
                        height=600,
                        title='COS FUV breakdown')
    #charts.show(plot)
    #print(settings)

    '''
    #-- COS NUV
    settings = Counter(configs['NUV'])
    charts.output_file("pie_config_cos_nuv.html")

    plot = charts.Donut(settings.values(),
                        settings.keys(),
                        width=1200,
                        height=600,
                        title='COS NUV breakdown')
    charts.show(plot)
    print(settings)
    '''

    #-- STIS FUV
    settings = Counter(configs['FUV-MAMA'])
    charts.output_file(os.path.join(SETTINGS['plot_dir'], "pie_config_stis_fuv.html"))

    plot = charts.Donut(settings.values(),
                        settings.keys(),
                        width=1200,
                        height=600,
                        title='STIS FUV breakdown')
    #charts.show(plot)
    #print(settings)

    #-- STIS NUV
    settings = Counter(configs['NUV-MAMA'])
    charts.output_file(os.path.join(SETTINGS['plot_dir'], "pie_config_stis_nuv.html"))

    plot = charts.Donut(settings.values(),
                        settings.keys(),
                        width=1200,
                        height=600,
                        title='STIS NUV breakdown')
    #charts.show(plot)
    #print(settings)

#-------------------------------------------------------------------------------

def simple_stat_plots():

    query = session.query(Stats.total, Stats.stdev).all()

    counts = []
    std = []
    for row in query:
        counts.append(row['total'])
        std.append(row['stdev'])


#-------------------------------------------------------------------------------

def dataset_dashboard(filename, plot_file=''):
    if not plot_file:
        plot_file = filename.replace('.fits', '.html')
        print(plot_file)
    if os.path.exists(plot_file):
        os.remove(plot_file)

    bokeh.io.output_file(plot_file)
    TOOLS = "pan,wheel_zoom,box_zoom,reset,resize,box_select,lasso_select,save"

    with fits.open(filename) as hdu:
        source = bokeh.models.ColumnDataSource(data={col : hdu[1].data[col] for col in hdu[1].data.names})

        endless_colors = itertools.cycle(palettes.Spectral6)
        colors = [endless_colors.next() for i in np.unique(hdu[1].data['dataset'])]

        dset_counts = Counter(hdu[1].data['dataset'])
        repeats = [dset_counts[key] for key in sorted(dset_counts.keys())]

        colors = np.repeat(colors, repeats)

        axes = []
        for key in ['gross', 'net', 'flux', 'error', 'background']:
            if len(axes) == 0:
                axes.append(figure(tools=TOOLS, plot_width=900, plot_height=350, title=key, toolbar_location="right"))
            else:
                axes.append(figure(tools=TOOLS, x_range=axes[0].x_range, plot_width=900, plot_height=350, title=key, toolbar_location="right"))
            axes[-1].circle('mjd',
                            key,
                            source=source,
                            size=12,
                            color=colors,
                            fill_alpha=1)


    # put all the plots in a grid layout
    p = bokeh.io.vplot(*axes)

    charts.save(obj=p, filename=plot_file)
    charts.reset_output()
    del p

#-------------------------------------------------------------------------------

def plot_dataset(filename, plot_file=''):
    path, name = os.path.split(filename)

    if not plot_file:
        plot_file = name.replace('.fits', '.html')
    if os.path.exists(plot_file):
        os.remove(plot_file)

    TOOLS = "pan,wheel_zoom,box_zoom,box_select,lasso_select,reset,resize,save"


    p = figure(tools=TOOLS, toolbar_location="above", logo="grey", plot_width=700)
    #p.title = "{} LightCurve".format(name)
    p.background_fill= "#cccccc"

    with fits.open(filename) as hdu:
        p.circle(hdu[1].data['MJD'],
                 hdu[1].data['FLUX'],
                 size=12,
                 line_color="black",
                 fill_alpha=0.8)


    p.xaxis.axis_label="Time (MJD)"
    p.yaxis.axis_label="Net (cnts/sec)"
    p.grid.grid_line_color="white"

    charts.save(obj=p, filename=plot_file)
    charts.reset_output()
    del p

    #charts.show(p)

    #script, div = components(p)

    #print(div)
    #print()
    #print(script)
#-------------------------------------------------------------------------------

def plot_dataset_static(filename, plot_file=''):
    if not plot_file:
        plot_file = filename.replace('.fits', '.png')
        print(plot_file)
    if os.path.exists(plot_file):
        os.remove(plot_file)

    fig = plt.figure(figsize=(10, 1))
    ax = fig.add_subplot(1, 1, 1)

    with fits.open(filename) as hdu:
        indx = np.argsort(hdu[1].data['MJD'])
        xvals = np.arange(len(hdu[1].data['MJD']))
        yvals = hdu[1].data['FLUX']

        try:
            colors = hdu[1].data['dataset'][indx]
        except KeyError:
            colors = np.ones(xvals.shape)

        ax.scatter(xvals,
                   yvals[indx],
                   c=colors,
                   marker='o')

    ax.set_xlim(0, xvals.max())
    ax.set_ylim(yvals[indx].min(), yvals[indx].max())
    fig.savefig(plot_file, bbox_inches='tight')
    plt.close(fig)
    del fig

#-------------------------------------------------------------------------------

def make_all_plots():
    pool = mp.Pool(processes=10)

    data_dir = SETTINGS['composite_dir']
    datasets = glob.glob(os.path.join(data_dir, '*.fits'))
    print("Matplotlib")
    pool.map(plot_dataset_static, datasets)
    print("bokeh")
    pool.map(dataset_dashboard, datasets)

#-------------------------------------------------------------------------------

def make_exploratory_table(dataset_list, table_name):
    info = []
    for dataset in dataset_list:
        path, name = os.path.split(dataset)

        with fits.open(dataset) as hdu:
            exptime = hdu[0].header['EXPTIME']

        targname = os.path.split(dataset)[1].split('_')[0]
        instrument = os.path.split(dataset)[1].split('_')[1]
        grating = os.path.split(dataset)[1].split('_')[2]
        cenwave = os.path.split(dataset)[1].split('_')[3]

        results = connection.execute("""SELECT total,mean,poisson_factor,pearson_r,pearson_p FROM stats WHERE lightcurve_filename='{}';""".format(name))
        total, mean, poisson_f, pearson_r, pearson_p = results.fetchall()[0]

        print(targname, instrument, grating, cenwave, poisson_f)

        plot_name = dataset.replace('.fits', '.html')
        plot_name_static = dataset.replace('.fits', '.png')

        plot_html = """<a href="{}" target="_blank"><img width="400" src="{}"><a>""".format(plot_name, plot_name_static)
        new_row = (targname, plot_html, instrument, grating, cenwave, exptime, total, mean, poisson_f, pearson_r, pearson_p, dataset)
        info.append(new_row)

    out_tab = Table(rows=info,
                    names=('target', 'plot', 'instrument', 'grating', 'cenwave', 'exptime', 'total', 'mean', 'poisson_f', 'pearson_r', 'pearson_p', 'filename'))
    out_tab.write(table_name, format='jsviewer')

    os.system("""sed -i '' "s/&lt;/</g" {}""".format(table_name))
    os.system("""sed -i '' "s/&gt;/>/g" {}""".format(table_name))

#-------------------------------------------------------------------------------

if __name__ == "__main__":
    print("Making plots for HSTLC")
    make_all_plots()

    engine = create_engine(SETTINGS['db_connection_string'])
    connection = engine.connect()

    #-- find interesting datasets
    results = connection.execute("""SELECT lightcurve_path,lightcurve_filename
                                            FROM stats
                                                WHERE poisson_factor IS NOT NULL
                                                    AND poisson_factor>=1.2
                                                    AND lightcurve_path LIKE '%%composite%%';""")
    interesting_datasets = [os.path.join(item[0], item[1]) for item in results.fetchall()]
    make_exploratory_table(interesting_datasets, os.path.join(SETTINGS['plot_dir'], 'interesting_hstlc.html'))

    #-- find interesting datasets
    results = connection.execute("""SELECT lightcurve_path,lightcurve_filename
                                            FROM stats
                                                WHERE poisson_factor IS NOT NULL
                                                    AND poisson_factor<1.2
                                                    AND lightcurve_path LIKE '%%composite%%';""")
    boring_datasets = [os.path.join(item[0], item[1]) for item in results.fetchall()]
    make_exploratory_table(boring_datasets, os.path.join(SETTINGS['plot_dir'], 'boring_hstlc.html'))

    #-- find NULL
    results = connection.execute("""SELECT lightcurve_path,lightcurve_filename
                                            FROM stats
                                                WHERE poisson_factor IS NULL
                                                    AND lightcurve_path LIKE '%%composite%%';""")
    null_datasets = [os.path.join(item[0], item[1]) for item in results.fetchall()]
    make_exploratory_table(null_datasets, os.path.join(SETTINGS['plot_dir'], 'null_hstlc.html'))


    #histogram_exptime()
    #piechart_config()
    #bar_opt_elem
    #plot_dataset('/grp/hst/hstlc/hst13902/outputs/composite/V4046SGR_FUV_G130M_1300_curve.fits', 'example_flare.html')
    #plot_dataset('/grp/hst/hstlc/hst13902/outputs/composite/IR-COM_FUV_G140L_1105_curve.fits', 'example_transit.html')
